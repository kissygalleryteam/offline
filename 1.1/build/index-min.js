/*! offline - v1.1 - 2013-04-24 3:24:05 PM
* Copyright (c) 2013 bofang; Licensed  */
KISSY.add("gallery/offline/myoffline/1.1/localstorage",function(e){var t,n,r={},a="DEADLINE-KEY";return e.mix(r,{init:function(){var r=(new Date).getTime();t=localStorage,n=e.JSON.parse(t.getItem(a))||{};for(var i in n)n.hasOwnProperty(i)&&(dateKey=parseInt(n[i],10),dateBet=dateKey-r,0>=dateBet?(this.removeItem(i),delete n[i],this._saveDeadLine()):this._deadlineKey(i,dateBet));return this},setItem:function(e,r,i){if(i){var a=parseInt(i,10),o=(new Date).getTime();n[e]=a+o,this._deadlineKey(e,a),this._saveDeadLine()}return t.setItem(e,r),!0},getItem:function(e){return t.getItem(e)},removeItem:function(e){return t.removeItem(e),delete n[e],this._saveDeadLine(),!this.getItem(e)},clear:function(){return t.clear(),0===this.size()},size:function(){var e=t.length;return t[a]?e-1:e},getAll:function(n){var r,o=t.length,s={};for(i=0;o>i;i++)r=t.key(i),s[r]=t.getItem(r),r===a&&delete s[r];return n?s:e.JSON.stringify(s)},timeRemain:function(e){return t[e]?e in n?n[e]-(new Date).getTime():-1:0},usedByte:function(){var r=this.getAll().length;return t[a]&&(r+=e.JSON.stringify(n).length,r+=a.length),r},_deadlineKey:function(r,i){var a=this;e.later(function(){t.removeItem(r),delete n[r],a._saveDeadLine()},i)},_saveDeadLine:function(){t.setItem(a,e.JSON.stringify(n))}}),r}),KISSY.add("gallery/offline/myoffline/1.1/ie-offline",function(e){var t,n,r,i={},a=document,o=(new Date).getTime(),s="IE-OFFLINE",u="IE-SINGLE-KEY",l="TIME-DEADLINE";return e.mix(i,{init:function(){return t=a.createElement("link"),t.addBehavior&&(t.style.behavior="url(#default#userData)",a.getElementsByTagName("head")[0].appendChild(t)),t.load(s),n=e.JSON.parse(t.getAttribute(u))||{},r=e.JSON.parse(t.getAttribute(l))||{},this._initDeadline(),this},_initDeadline:function(){var e,t;for(var n in r)r.hasOwnProperty(n)&&(e=parseInt(r[n],10),t=e-o,0>=t?this.removeItem(n):this._deadlineKey(n,t))},setItem:function(e,t,i){if(n[e]=t,i){var a=parseInt(i,10),o=(new Date).getTime();r[e]=a+o,this._deadlineKey(e,a)}return this._saveToBrowser()},getItem:function(e){return n[e]},removeItem:function(e){return delete n[e],delete r[e],this._saveToBrowser()},clear:function(){return n={},r={},this._saveToBrowser()},size:function(){var e=0;for(var t in n)n.hasOwnProperty(t)&&e++;return e},timeRemain:function(e){return e in n?e in r?r[e]-(new Date).getTime():-1:0},usedByte:function(){var t=0,i=e.JSON.stringify(r);return""!==r&&(t+=i.length+l.length),t+=e.JSON.stringify(n).length},getAll:function(t){return t?n:e.JSON.stringify(n)},_deadlineKey:function(t,n){var r=this;e.later(function(){r.removeItem(t)},n)},_saveToBrowser:function(){var i=!0;try{t.setAttribute(l,e.JSON.stringify(r)),t.setAttribute(u,e.JSON.stringify(n)),t.save(s)}catch(a){i=!1}return i}}),i}),KISSY.add("gallery/offline/myoffline/1.1/index",function(e,t,n){function r(){r.superclass.constructor.call(this)}var i=window.localStorage!==void 0?t:8>e.UA.ie?n:null;return i.init(),e.extend(r,e.Base,{setItem:function(t,n,r){var a=parseInt(r,10);return e.isString(t)&&e.isString(n)&&""!==e.trim(t)?(e.Offline.fire("setItem",{key:t,value:n,deadline:r}),i.setItem(t,n,a)):(e.error("Format error"),!1)},getItem:function(t){return e.isString(t)?i.getItem(t):(e.error("Need String"),null)},removeItem:function(t){return e.isString(t)?(e.Offline.fire("removeItem",{key:t}),i.removeItem(t)):(e.error("Need String"),!1)},clear:function(){return e.Offline.fire("clear"),i.clear()},getAll:function(e){return i.getAll(e)},size:function(){return i.size()},timeRemain:function(t){return e.isString(t)?i.timeRemain(t):(e.error("Need String"),!1)},usedByte:function(){return i.usedByte()}}),e.Offline=new r,r},{requires:["./localstorage","./ie-offline"]});